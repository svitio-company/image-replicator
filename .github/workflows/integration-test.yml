name: Integration Test

on:
  pull_request:
    branches: [main]

jobs:
  integration-test:
    name: Test Deployment on Kind
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Create Kind Cluster with Registry
        id: kind
        uses: helm/kind-action@v1
        with:
          registry: true
          registry_name: my-registry
          registry_port: 5001
          registry_enable_delete: true

      - name: Build and push Docker image
        run: |
          docker build -t localhost:5001/image-cloner-operator:test .
          docker push localhost:5001/image-cloner-operator:test

      - name: Install cert-manager
        run: |
          helm install \
            cert-manager oci://quay.io/jetstack/charts/cert-manager \
            --version v1.19.2 \
            --namespace cert-manager \
            --create-namespace \
            --set crds.enabled=true \
            --wait --timeout=5m

      - name: Install Helm chart
        run: |
          helm install image-replicator ./chart \
            --set image.repository=my-registry:5001/image-cloner-operator \
            --set image.tag=test \
            --set extraEnv[0].name=TARGET_REGISTRY \
            --set extraEnv[0].value=localhost:5001 \
            --set extraEnv[1].name=INSECURE_REGISTRIES \
            --set extraEnv[1].value=localhost:5001 \
            --set extraEnv[2].name=DEBUG \
            --set-string extraEnv[2].value=true \
            --set certManager.certificate.privateKey.rotationPolicy=Always \
            --set webhook.namespaceSelector.matchExpressions[0].key=kubernetes.io/metadata.name \
            --set webhook.namespaceSelector.matchExpressions[0].operator=NotIn \
            --set webhook.namespaceSelector.matchExpressions[0].values[0]=default \
            --set webhook.namespaceSelector.matchExpressions[0].values[1]=kube-system \
            --set webhook.namespaceSelector.matchExpressions[0].values[2]=cert-manager \
            --debug

      - name: Wait for deployment
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=image-replicator --timeout=300s

      - name: Check deployment status
        if: always()
        run: |
          echo "=== Pods ==="
          kubectl get pods -A
          echo ""
          echo "=== Deployment ==="
          kubectl describe deployment -n default
          echo ""
          echo "=== Pod Details ==="
          kubectl describe pods -l app.kubernetes.io/name=image-replicator -n default
          echo ""
          echo "=== Pod Logs ==="
          kubectl logs -l app.kubernetes.io/name=image-replicator -n default --all-containers=true --tail=200 || true
          echo ""
          echo "=== Events ==="
          kubectl get events -n default --sort-by='.lastTimestamp'

      - name: Verify deployment
        run: |
          kubectl get pods -A
          kubectl get all -n default

      - name: Test registry connectivity
        run: |
          echo "=== Checking registry container details ==="
          docker ps | grep registry
          docker inspect my-registry || docker inspect kind-registry || echo "Registry container not found"
          
          echo ""
          echo "=== Getting registry container IP ==="
          REGISTRY_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' my-registry 2>/dev/null || docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' kind-registry 2>/dev/null || echo "")
          echo "Registry IP: $REGISTRY_IP"
          
          echo ""
          echo "=== Checking registry service/endpoint in Kubernetes ==="
          kubectl get svc -A | grep registry || echo "No registry service found"
          kubectl get endpoints -A | grep registry || echo "No registry endpoints found"
          
          echo ""
          echo "=== Testing registry from GitHub Actions runner ==="
          curl -v http://localhost:5001/v2/ || echo "Failed from runner via localhost:5001"
          curl -v http://my-registry:5001/v2/ || echo "Failed from runner via my-registry:5001"
          if [ -n "$REGISTRY_IP" ]; then
            curl -v http://$REGISTRY_IP:5001/v2/ || echo "Failed from runner via IP"
          fi
          
          echo ""
          echo "=== Testing registry from Kind node ==="
          docker exec kind-control-plane curl -v http://my-registry:5001/v2/ || echo "Failed from node via my-registry:5001"
          docker exec kind-control-plane curl -v http://localhost:5001/v2/ || echo "Failed from node via localhost:5001"
          if [ -n "$REGISTRY_IP" ]; then
            docker exec kind-control-plane curl -v http://$REGISTRY_IP:5001/v2/ || echo "Failed from node via IP"
          fi
          
          echo ""
          echo "=== Testing DNS resolution from Kind node ==="
          docker exec kind-control-plane nslookup my-registry || echo "DNS resolution failed for my-registry"
          docker exec kind-control-plane getent hosts my-registry || echo "getent failed for my-registry"
          
          echo ""
          echo "=== Checking network connectivity from test pod ==="
          kubectl run test-curl --image=curlimages/curl:latest --rm -i --restart=Never -- curl -v http://my-registry:5001/v2/ || echo "Failed from pod via my-registry:5001"
          
          echo ""
          echo "=== Testing localhost:5001 from test pod ==="
          kubectl run test-curl-localhost --image=curlimages/curl:latest --rm -i --restart=Never -- curl -v http://localhost:5001/v2/ || echo "Failed from pod via localhost:5001"
          
          if [ -n "$REGISTRY_IP" ]; then
            echo ""
            echo "=== Testing registry IP from test pod ==="
            kubectl run test-curl-ip --image=curlimages/curl:latest --rm -i --restart=Never -- curl -v http://$REGISTRY_IP:5001/v2/ || echo "Failed from pod via IP"
          fi
          
          echo ""
          echo "=== Testing from operator pod namespace ==="
          POD_NAME=$(kubectl get pods -l app.kubernetes.io/name=image-replicator -n default -o jsonpath='{.items[0].metadata.name}')
          if [ -n "$POD_NAME" ]; then
            echo "Operator pod: $POD_NAME"
            kubectl run test-curl-default --image=curlimages/curl:latest --rm -i --restart=Never -n default -- curl -v http://my-registry:5001/v2/ || echo "Failed from default namespace via my-registry:5001"
          fi

      - name: Test webhook with nginx pod
        run: |
          echo "=== Creating test namespace ==="
          kubectl create namespace test-namespace || true
          
          echo ""
          echo "=== Creating test nginx pod ==="
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Pod
          metadata:
            name: test-nginx
            namespace: test-namespace
            labels:
              app: test-nginx
          spec:
            containers:
            - name: nginx
              image: nginx:1.29.4-alpine-slim
              ports:
              - containerPort: 80
          EOF
          
          echo ""
          echo "=== Waiting for pod to be created ==="
          kubectl wait --for=condition=ready pod/test-nginx -n test-namespace --timeout=120s || true
          
          echo ""
          echo "=== Pod Status ==="
          kubectl get pod test-nginx -n test-namespace -o wide
          
          echo ""
          echo "=== Pod Events ==="
          kubectl describe pod test-nginx -n test-namespace

      - name: Verify image was copied to local registry
        run: |
          echo "=== Checking if nginx image was copied to local registry ==="
          
          # Check registry catalog
          echo "Registry catalog:"
          curl -s http://my-registry:5001/v2/_catalog || echo "Failed to get catalog"
          
          # Check if nginx repository exists
          echo ""
          echo "Checking nginx tags:"
          curl -s http://my-registry:5001/v2/library/nginx/tags/list || echo "nginx not found in registry"
          
          # Verify the image manifest exists
          echo ""
          echo "Verifying nginx:1.25-alpine manifest:"
          curl -s -I http://my-registry:5001/v2/library/nginx/manifests/1.25-alpine || echo "Manifest not found"

      - name: Show replicator logs
        if: always()
        run: |
          echo "=== Pod Logs ==="
          kubectl logs -l app.kubernetes.io/name=image-replicator -n default --all-containers=true --tail=200 || true

      - name: Check webhook logs
        run: |
          echo "=== Webhook Logs (Last 100 lines) ==="
          kubectl logs -l app.kubernetes.io/name=imn test-namespace -o jsonpath='{.status.phase}')
          echo "Pod status: $POD_STATUS"
          
          if [ "$POD_STATUS" != "Running" ]; then
            echo "ERROR: Pod is not running!"
            kubectl describe pod test-nginx -n test-namespace
            exit 1
          fi
          
          echo "SUCCESS: Pod is running with image from local registry!"

      - name: Test pod functionality
        run: |
          echo "=== Testing nginx responds ==="
          kubectl exec test-nginx -n test-namespace -- curl -s http://localhost || echo "Curl failed"
          
          echo ""
          echo "=== Nginx version ==="
          kubectl exec test-nginx -n test-namespace -- nginx -v

      - name: Cleanup test resources
        if: always()
        run: |
          kubectl delete namespace test-namespaceinx -v

      - name: Cleanup test resources
        if: always()
        run: |
          kubectl delete pod test-nginx --ignore-not-found=true

      - name: Show logs on failure
        if: failure()
        run: |
          kubectl get pods -A
          kubectl describe pods -l app.kubernetes.io/name=image-replicator
          kubectl logs -l app.kubernetes.io/name=image-replicator --all-containers=true --tail=500
